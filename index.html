<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barber√≠a Pro - Sistema de Gesti√≥n Profesional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#D4AF37',
                        secondary: '#FFD700',
                        dark: '#0A0A0A',
                        'dark-lighter': '#1A1A1A',
                        'dark-card': '#141414'
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;900&family=Rajdhani:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Rajdhani', sans-serif;
        }
        
        h1, h2, h3, .font-display {
            font-family: 'Orbitron', sans-serif;
        }
        
        .gradient-gold {
            background: linear-gradient(135deg, #D4AF37 0%, #FFD700 50%, #D4AF37 100%);
            background-size: 200% 200%;
            animation: gradientShift 3s ease infinite;
        }
        
        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        .glow {
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.3);
        }
        
        .glow-strong {
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.6), 0 0 60px rgba(212, 175, 55, 0.3);
        }
        
        .slide-in {
            animation: slideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            animation: slideInRight 0.3s ease-out;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 40px rgba(212, 175, 55, 0.2);
        }
        
        .loader {
            border: 3px solid rgba(212, 175, 55, 0.1);
            border-top-color: #D4AF37;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-dark text-gray-100 min-h-screen">
    <div id="app"></div>
    <div id="notifications"></div>

    <script>
        // ========================================
        // CONFIGURACI√ìN DE SUPABASE
        // ========================================
        const SUPABASE_URL = 'https://icmwollqqgpefwovhwdm.supabase.co'; // CAMBIAR POR TU URL
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImljbXdvbGxxcWdwZWZ3b3Zod2RtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5NTA0MDksImV4cCI6MjA3NzUyNjQwOX0.5r9SoLu-Ir3uLCOKBfLnyysgM35N1WSYQonLmkkX5yY'; // CAMBIAR POR TU KEY
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // ========================================
        // UTILIDADES Y NOTIFICACIONES
        // ========================================
        class Notifier {
            static show(message, type = 'success') {
                const container = document.getElementById('notifications');
                const notification = document.createElement('div');
                
                const colors = {
                    success: 'bg-green-600',
                    error: 'bg-red-600',
                    warning: 'bg-yellow-600',
                    info: 'bg-blue-600'
                };
                
                notification.className = `notification ${colors[type]} text-white px-6 py-4 rounded-lg shadow-2xl flex items-center space-x-3`;
                notification.innerHTML = `
                    <span class="text-2xl">${type === 'success' ? '‚úì' : type === 'error' ? '‚úï' : '‚Ñπ'}</span>
                    <span class="font-medium">${message}</span>
                `;
                
                container.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.animation = 'slideInRight 0.3s ease-out reverse';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }
        }

        class Loader {
            static show() {
                const loader = document.createElement('div');
                loader.id = 'global-loader';
                loader.className = 'fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50';
                loader.innerHTML = `
                    <div class="text-center">
                        <div class="loader mx-auto mb-4"></div>
                        <p class="text-primary font-medium">Cargando...</p>
                    </div>
                `;
                document.body.appendChild(loader);
            }
            
            static hide() {
                const loader = document.getElementById('global-loader');
                if (loader) loader.remove();
            }
        }

        // ========================================
        // GESTOR DE DATOS CON SUPABASE
        // ========================================
        class DataManager {
            static async init() {
                // Crear tablas si no existen (ejecutar una sola vez en Supabase SQL Editor)
                console.log('Inicializando base de datos...');
            }

            // AUTENTICACI√ìN
            static async login(email, password) {
                try {
                    const { data: user, error } = await supabase
                        .from('usuarios')
                        .select('*')
                        .eq('email', email)
                        .eq('password', password) // En producci√≥n usar bcrypt
                        .single();
                    
                    if (error || !user) return null;
                    
                    await window.storage.set('currentUser', JSON.stringify(user));
                    return user;
                } catch (error) {
                    console.error('Error login:', error);
                    return null;
                }
            }

            static async register(email, password, nombre) {
                try {
                    const { data: existing } = await supabase
                        .from('usuarios')
                        .select('id')
                        .eq('email', email)
                        .single();
                    
                    if (existing) {
                        return { success: false, message: 'El email ya est√° registrado' };
                    }

                    const { data, error } = await supabase
                        .from('usuarios')
                        .insert([{ email, password, nombre, rol: 'CLIENTE' }])
                        .select()
                        .single();
                    
                    if (error) throw error;
                    
                    return { success: true, message: 'Usuario registrado exitosamente' };
                } catch (error) {
                    console.error('Error registro:', error);
                    return { success: false, message: 'Error al registrar usuario' };
                }
            }

            static async getCurrentUser() {
                try {
                    const stored = await window.storage.get('currentUser');
                    return stored ? JSON.parse(stored.value) : null;
                } catch {
                    return null;
                }
            }

            static async logout() {
                await window.storage.delete('currentUser');
            }

            // SERVICIOS
            static async getServicios() {
                try {
                    const { data, error } = await supabase
                        .from('servicios')
                        .select('*')
                        .order('nombre');
                    return data || [];
                } catch (error) {
                    console.error('Error obteniendo servicios:', error);
                    return [];
                }
            }

            static async saveServicio(servicio) {
                try {
                    if (servicio.id) {
                        const { error } = await supabase
                            .from('servicios')
                            .update(servicio)
                            .eq('id', servicio.id);
                        if (error) throw error;
                    } else {
                        const { error } = await supabase
                            .from('servicios')
                            .insert([servicio]);
                        if (error) throw error;
                    }
                    return true;
                } catch (error) {
                    console.error('Error guardando servicio:', error);
                    return false;
                }
            }

            static async deleteServicio(id) {
                try {
                    const { error } = await supabase
                        .from('servicios')
                        .delete()
                        .eq('id', id);
                    return !error;
                } catch (error) {
                    console.error('Error eliminando servicio:', error);
                    return false;
                }
            }

            // BARBEROS
            static async getBarberos() {
                try {
                    const { data, error } = await supabase
                        .from('barberos')
                        .select(`
                            *,
                            usuario:usuarios(*)
                        `);
                    return data || [];
                } catch (error) {
                    console.error('Error obteniendo barberos:', error);
                    return [];
                }
            }

            // CITAS
            static async getCitas() {
                try {
                    const { data, error } = await supabase
                        .from('citas')
                        .select(`
                            *,
                            servicio:servicios(*),
                            cliente:usuarios!cliente_id(*),
                            barbero:barberos(*, usuario:usuarios(*))
                        `)
                        .order('fecha_hora', { ascending: false });
                    return data || [];
                } catch (error) {
                    console.error('Error obteniendo citas:', error);
                    return [];
                }
            }

            static async saveCita(cita) {
                try {
                    if (cita.id) {
                        const { error } = await supabase
                            .from('citas')
                            .update(cita)
                            .eq('id', cita.id);
                        if (error) throw error;
                    } else {
                        const { error } = await supabase
                            .from('citas')
                            .insert([cita]);
                        if (error) throw error;
                    }
                    return true;
                } catch (error) {
                    console.error('Error guardando cita:', error);
                    return false;
                }
            }

            // INVENTARIO
            static async getInventario() {
                try {
                    const { data, error } = await supabase
                        .from('inventario')
                        .select('*')
                        .order('nombre');
                    return data || [];
                } catch (error) {
                    console.error('Error obteniendo inventario:', error);
                    return [];
                }
            }

            static async saveInventario(item) {
                try {
                    if (item.id) {
                        const { error } = await supabase
                            .from('inventario')
                            .update(item)
                            .eq('id', item.id);
                        if (error) throw error;
                    } else {
                        const { error } = await supabase
                            .from('inventario')
                            .insert([item]);
                        if (error) throw error;
                    }
                    return true;
                } catch (error) {
                    console.error('Error guardando inventario:', error);
                    return false;
                }
            }
        }

        // ========================================
        // APLICACI√ìN PRINCIPAL
        // ========================================
        class App {
            constructor() {
                this.currentView = 'login';
                this.currentUser = null;
                this.init();
            }

            async init() {
                Loader.show();
                this.currentUser = await DataManager.getCurrentUser();
                if (this.currentUser) {
                    this.currentView = 'home';
                }
                await this.render();
                Loader.hide();
            }

            async render() {
                const appDiv = document.getElementById('app');

                if (!this.currentUser) {
                    appDiv.innerHTML = this.renderLogin();
                    this.attachLoginEvents();
                } else {
                    appDiv.innerHTML = await this.renderDashboard();
                    this.attachDashboardEvents();
                }
            }

            renderLogin() {
                return `
                    <div class="min-h-screen flex items-center justify-center px-4 relative overflow-hidden">
                        <div class="absolute inset-0 opacity-10">
                            <div class="absolute top-20 left-10 w-72 h-72 bg-primary rounded-full blur-3xl"></div>
                            <div class="absolute bottom-20 right-10 w-96 h-96 bg-secondary rounded-full blur-3xl"></div>
                        </div>
                        
                        <div class="bg-dark-card border border-primary/20 rounded-2xl shadow-2xl glow p-8 w-full max-w-md relative z-10 slide-in">
                            <div class="text-center mb-8">
                                <div class="inline-block gradient-gold text-transparent bg-clip-text mb-4">
                                    <h1 class="text-5xl font-display font-bold">‚úÇÔ∏è</h1>
                                </div>
                                <h1 class="text-4xl font-display font-bold gradient-gold text-transparent bg-clip-text mb-2">Barber√≠a Pro</h1>
                                <p class="text-gray-400 font-light">Sistema de Gesti√≥n Premium</p>
                            </div>

                            <div class="mb-6">
                                <div class="flex rounded-lg bg-dark-lighter p-1">
                                    <button id="tab-login" class="flex-1 py-3 px-4 rounded-md font-medium transition-all bg-primary text-dark shadow-lg">
                                        Iniciar Sesi√≥n
                                    </button>
                                    <button id="tab-register" class="flex-1 py-3 px-4 rounded-md font-medium transition-all text-gray-400 hover:text-primary">
                                        Registrarse
                                    </button>
                                </div>
                            </div>

                            <div id="login-form">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-2 text-gray-300">Email</label>
                                        <input type="email" id="login-email" class="w-full px-4 py-3 rounded-lg bg-dark-lighter border border-primary/30 focus:border-primary focus:ring-2 focus:ring-primary/50 transition-all text-white placeholder-gray-500" placeholder="tu@email.com">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2 text-gray-300">Contrase√±a</label>
                                        <input type="password" id="login-password" class="w-full px-4 py-3 rounded-lg bg-dark-lighter border border-primary/30 focus:border-primary focus:ring-2 focus:ring-primary/50 transition-all text-white placeholder-gray-500" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                                    </div>
                                    <button id="btn-login" class="w-full gradient-gold text-dark font-bold py-3 px-6 rounded-lg transition-all shadow-lg hover:shadow-xl glow-strong">
                                        INICIAR SESI√ìN
                                    </button>
                                </div>

                                <div class="mt-6 p-4 bg-primary/10 border border-primary/20 rounded-lg">
                                    <p class="text-sm font-semibold mb-2 text-primary">Demo (usar estos datos):</p>
                                    <p class="text-xs text-gray-400">
                                        <strong>Admin:</strong> admin@barberia.com / admin123<br>
                                        <strong>Cliente:</strong> cliente@test.com / cliente123
                                    </p>
                                </div>
                            </div>

                            <div id="register-form" class="hidden">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-2 text-gray-300">Nombre Completo</label>
                                        <input type="text" id="register-nombre" class="w-full px-4 py-3 rounded-lg bg-dark-lighter border border-primary/30 focus:border-primary focus:ring-2 focus:ring-primary/50 transition-all text-white" placeholder="Juan P√©rez">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2 text-gray-300">Email</label>
                                        <input type="email" id="register-email" class="w-full px-4 py-3 rounded-lg bg-dark-lighter border border-primary/30 focus:border-primary focus:ring-2 focus:ring-primary/50 transition-all text-white" placeholder="tu@email.com">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2 text-gray-300">Contrase√±a</label>
                                        <input type="password" id="register-password" class="w-full px-4 py-3 rounded-lg bg-dark-lighter border border-primary/30 focus:border-primary focus:ring-2 focus:ring-primary/50 transition-all text-white" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                                    </div>
                                    <button id="btn-register" class="w-full gradient-gold text-dark font-bold py-3 px-6 rounded-lg transition-all shadow-lg hover:shadow-xl glow-strong">
                                        CREAR CUENTA
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            async renderDashboard() {
                const navigation = this.renderNavigation();
                let content = '';

                switch(this.currentView) {
                    case 'servicios':
                        content = await this.renderServicios();
                        break;
                    case 'inventario':
                        content = await this.renderInventario();
                        break;
                    case 'reservar':
                        content = await this.renderReservar();
                        break;
                    case 'mis-citas':
                        content = await this.renderMisCitas();
                        break;
                    default:
                        content = await this.renderHome();
                }

                return `
                    <div class="min-h-screen bg-dark">
                        ${navigation}
                        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                            ${content}
                        </main>
                    </div>
                `;
            }

            renderNavigation() {
                const menuItems = [
                    { name: 'Inicio', view: 'home', icon: 'üè†' }
                ];

                if (this.currentUser.rol === 'ADMIN') {
                    menuItems.push(
                        { name: 'Servicios', view: 'servicios', icon: '‚úÇÔ∏è' },
                        { name: 'Inventario', view: 'inventario', icon: 'üì¶' }
                    );
                } else if (this.currentUser.rol === 'CLIENTE') {
                    menuItems.push(
                        { name: 'Reservar', view: 'reservar', icon: 'üìÖ' },
                        { name: 'Mis Citas', view: 'mis-citas', icon: 'üìã' }
                    );
                }

                return `
                    <nav class="bg-dark-card border-b border-primary/20 glow sticky top-0 z-40 backdrop-blur-lg">
                        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div class="flex justify-between items-center h-16">
                                <div class="flex items-center space-x-8">
                                    <h1 class="text-2xl font-display font-bold gradient-gold text-transparent bg-clip-text">‚úÇÔ∏è Barber√≠a Pro</h1>
                                    <div class="hidden md:flex space-x-2">
                                        ${menuItems.map(item => `
                                            <button class="nav-item px-4 py-2 rounded-lg font-medium transition-all ${this.currentView === item.view ? 'bg-primary text-dark' : 'text-gray-400 hover:text-primary hover:bg-dark-lighter'}" data-view="${item.view}">
                                                ${item.icon} ${item.name}
                                            </button>
                                        `).join('')}
                                    </div>
                                </div>
                                <div class="flex items-center space-x-4">
                                    <div class="text-right">
                                        <p class="text-sm font-medium text-primary">${this.currentUser.nombre}</p>
                                        <p class="text-xs text-gray-400">${this.currentUser.rol}</p>
                                    </div>
                                    <button id="btn-logout" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-all font-medium">
                                        Salir
                                    </button>
                                </div>
                            </div>
                        </div>
                    </nav>
                `;
            }

            async renderHome() {
                const servicios = await DataManager.getServicios();
                const citas = await DataManager.getCitas();
                const inventario = await DataManager.getInventario();

                return `
                    <div class="slide-in">
                        <h2 class="text-4xl font-display font-bold mb-8 gradient-gold text-transparent bg-clip-text">
                            Bienvenido, ${this.currentUser.nombre}
                        </h2>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            ${[
                                { label: 'Servicios', value: servicios.length, icon: '‚úÇÔ∏è', color: 'from-yellow-600 to-yellow-400' },
                                { label: 'Citas', value: citas.length, icon: 'üìÖ', color: 'from-blue-600 to-blue-400' },
                                { label: 'Inventario', value: inventario.length, icon: 'üì¶', color: 'from-purple-600 to-purple-400' }
                            ].map(stat => `
                                <div class="bg-dark-card border border-primary/20 rounded-xl shadow-lg p-6 card-hover glow">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-gray-400 text-sm mb-1">${stat.label}</p>
                                            <p class="text-4xl font-bold text-primary">${stat.value}</p>
                                        </div>
                                        <div class="text-6xl opacity-20">${stat.icon}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>

                        <div class="bg-gradient-to-r ${this.currentUser.rol === 'ADMIN' ? 'from-primary/20 to-secondary/20' : 'from-blue-600/20 to-purple-600/20'} border border-primary/30 rounded-xl shadow-lg p-8 glow">
                            <h3 class="text-2xl font-display font-bold mb-4 text-primary">Nuestros Servicios Premium</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                ${servicios.slice(0, 6).map(s => `
                                    <div class="bg-dark-card/50 backdrop-blur rounded-lg p-4 border border-primary/20">
                                        <h4 class="font-semibold mb-2 text-white">${s.nombre}</h4>
                                        <p class="text-sm text-gray-400">‚è±Ô∏è ${s.duracion} min | üí∞ $${s.precio}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }

            async renderServicios() {
                const servicios = await DataManager.getServicios();
                return `
                    <div class="slide-in">
                        <div class="flex justify-between items-center mb-8">
                            <h2 class="text-3xl font-display font-bold gradient-gold text-transparent bg-clip-text">Gesti√≥n de Servicios</h2>
                            <button id="btn-add-servicio" class="px-6 py-3 gradient-gold text-dark rounded-lg font-bold transition-all shadow-lg hover:shadow-xl glow-strong">
                                + NUEVO SERVICIO
                            </button>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            ${servicios.map(s => `
                                <div class="bg-dark-card border border-primary/20 rounded-xl shadow-lg p-6 card-hover glow">
                                    <div class="flex justify-between items-start mb-4">
                                        <div class="flex-1">
                                            <h3 class="text-xl font-bold mb-2 text-primary">${s.nombre}</h3>
                                            <div class="space-y-1">
                                                <p class="text-gray-400">‚è±Ô∏è ${s.duracion} minutos</p>
                                                <p class="text-2xl font-bold text-primary">$${s.precio}</p>
                                            </div>
                                        </div>
                                        <div class="flex space-x-2">
                                            <button class="btn-edit-servicio p-2 text-blue-400 hover:bg-blue-900/20 rounded-lg transition-all" data-id="${s.id}">‚úèÔ∏è</button>
                                            <button class="btn-delete-servicio p-2 text-red-400 hover:bg-red-900/20 rounded-lg transition-all" data-id="${s.id}">üóëÔ∏è</button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            async renderInventario() {
                const items = await DataManager.getInventario();
                return `
                    <div class="slide-in">
                        <div class="flex justify-between items-center mb-8">
                            <h2 class="text-3xl font-display font-bold gradient-gold text-transparent bg-clip-text">Gesti√≥n de Inventario</h2>
                            <button id="btn-add-inventario" class="px-6 py-3 gradient-gold text-dark rounded-lg font-bold transition-all shadow-lg hover:shadow-xl glow-strong">
                                + NUEVO PRODUCTO
                            </button>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                            ${items.map(item => `
                                <div class="bg-dark-card border ${item.cantidad <= item.minimo ? 'border-red-500' : 'border-primary/20'} rounded-xl shadow-lg p-6 card-hover glow">
                                    ${item.cantidad <= item.minimo ? '<div class="bg-red-600/20 text-red-400 px-3 py-1 rounded-full text-xs font-bold mb-3 inline-block">‚ö†Ô∏è STOCK BAJO</div>' : ''}
                                    <h3 class="text-lg font-bold mb-2 text-primary">${item.nombre}</h3>
                                    <div class="space-y-2">
                                        <p class="text-gray-400 text-sm">${item.descripcion || 'Sin descripci√≥n'}</p>
                                        <div class="flex justify-between items-center">
                                            <span class="text-2xl font-bold text-primary">${item.cantidad}</span>
                                            <span class="text-xs text-gray-500">M√≠n: ${item.minimo}</span>
                                        </div>
                                    </div>
                                    <div class="flex space-x-2 mt-4">
                                        <button class="btn-edit-inventario flex-1 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm transition-all" data-id="${item.id}">‚úèÔ∏è</button>
                                        <button class="btn-delete-inventario flex-1 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-sm transition-all" data-id="${item.id}">üóëÔ∏è</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            async renderReservar() {
                const servicios = await DataManager.getServicios();
                return `
                    <div class="slide-in max-w-3xl mx-auto">
                        <h2 class="text-3xl font-display font-bold mb-8 gradient-gold text-transparent bg-clip-text">Reservar Cita</h2>

                        <div class="bg-dark-card border border-primary/20 rounded-xl shadow-lg p-8 glow">
                            <div class="space-y-6">
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-gray-300">Servicio</label>
                                    <select id="select-servicio" class="w-full px-4 py-3 rounded-lg bg-dark-lighter border border-primary/30 focus:border-primary focus:ring-2 focus:ring-primary/50 transition-all text-white">
                                        <option value="">Seleccione un servicio</option>
                                        ${servicios.map(s => `
                                            <option value="${s.id}" data-duracion="${s.duracion}">${s.nombre} - ${s.precio} (${s.duracion} min)</option>
                                        `).join('')}
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium mb-2 text-gray-300">Fecha</label>
                                    <input type="date" id="input-fecha" class="w-full px-4 py-3 rounded-lg bg-dark-lighter border border-primary/30 focus:border-primary focus:ring-2 focus:ring-primary/50 transition-all text-white">
                                </div>

                                <div id="horarios-disponibles" class="hidden">
                                    <label class="block text-sm font-medium mb-2 text-gray-300">Horarios Disponibles</label>
                                    <div id="slots-container" class="grid grid-cols-3 sm:grid-cols-4 gap-3"></div>
                                </div>

                                <button id="btn-confirmar-reserva" class="w-full gradient-gold text-dark font-bold py-3 px-6 rounded-lg transition-all shadow-lg hover:shadow-xl glow-strong disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                    CONFIRMAR RESERVA
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            async renderMisCitas() {
                const citas = await DataManager.getCitas();
                const misCitas = citas.filter(c => c.cliente_id === this.currentUser.id);

                return `
                    <div class="slide-in">
                        <h2 class="text-3xl font-display font-bold mb-8 gradient-gold text-transparent bg-clip-text">Mis Citas</h2>

                        ${misCitas.length === 0 ? `
                            <div class="bg-dark-card border border-primary/20 rounded-xl shadow-lg p-12 text-center glow">
                                <div class="text-6xl mb-4 opacity-50">üìÖ</div>
                                <h3 class="text-xl font-semibold mb-2 text-primary">No tienes citas programadas</h3>
                                <p class="text-gray-400 mb-6">¬°Agenda tu primera cita ahora!</p>
                                <button class="nav-item px-6 py-3 gradient-gold text-dark rounded-lg font-bold transition-all shadow-lg hover:shadow-xl" data-view="reservar">
                                    RESERVAR CITA
                                </button>
                            </div>
                        ` : `
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                ${misCitas.map(c => {
                                    const fecha = new Date(c.fecha_hora);
                                    const isPast = fecha < new Date();
                                    return `
                                        <div class="bg-dark-card border border-primary/20 rounded-xl shadow-lg p-6 card-hover glow ${isPast ? 'opacity-60' : ''}">
                                            <div class="flex justify-between items-start mb-4">
                                                <div>
                                                    <span class="px-3 py-1 rounded-full text-xs font-semibold ${c.estado_asignacion === 'ASIGNADO' ? 'bg-green-600/20 text-green-400' : 'bg-yellow-600/20 text-yellow-400'}">
                                                        ${c.estado_asignacion}
                                                    </span>
                                                    ${isPast ? '<span class="ml-2 px-3 py-1 rounded-full text-xs font-semibold bg-gray-600/20 text-gray-400">PASADA</span>' : ''}
                                                </div>
                                            </div>
                                            <h3 class="text-xl font-bold mb-2 text-primary">${c.servicio?.nombre || 'Servicio eliminado'}</h3>
                                            <div class="space-y-1 text-sm text-gray-400">
                                                <p>üìÖ ${fecha.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                                                <p>üïê ${fecha.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })}</p>
                                                ${c.barbero ? `<p>üë®‚Äçüíº ${c.barbero.usuario?.nombre || 'Barbero'}</p>` : '<p>üë®‚Äçüíº Por asignar</p>'}
                                                ${c.servicio ? `<p class="text-primary font-bold text-lg mt-2">üí∞ ${c.servicio.precio}</p>` : ''}
                                            </div>
                                            ${!isPast && c.estado_asignacion === 'PENDIENTE' ? `
                                                <button class="btn-cancelar-cita w-full mt-4 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-all font-medium" data-id="${c.id}">
                                                    Cancelar Cita
                                                </button>
                                            ` : ''}
                                            ${c.estado_asignacion === 'ASIGNADO' && !isPast ? `
                                                <button class="btn-pagar-cita w-full mt-4 px-4 py-2 gradient-gold text-dark rounded-lg font-bold transition-all shadow-lg hover:shadow-xl" data-id="${c.id}" data-precio="${c.servicio?.precio || 0}">
                                                    üí≥ PAGAR ${c.servicio?.precio || 0}
                                                </button>
                                            ` : ''}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `}
                    </div>
                `;
            }

            // ========================================
            // EVENT HANDLERS
            // ========================================
            attachLoginEvents() {
                const tabLogin = document.getElementById('tab-login');
                const tabRegister = document.getElementById('tab-register');
                const loginForm = document.getElementById('login-form');
                const registerForm = document.getElementById('register-form');

                tabLogin?.addEventListener('click', () => {
                    tabLogin.classList.add('bg-primary', 'text-dark', 'shadow-lg');
                    tabLogin.classList.remove('text-gray-400');
                    tabRegister.classList.remove('bg-primary', 'text-dark', 'shadow-lg');
                    tabRegister.classList.add('text-gray-400');
                    loginForm.classList.remove('hidden');
                    registerForm.classList.add('hidden');
                });

                tabRegister?.addEventListener('click', () => {
                    tabRegister.classList.add('bg-primary', 'text-dark', 'shadow-lg');
                    tabRegister.classList.remove('text-gray-400');
                    tabLogin.classList.remove('bg-primary', 'text-dark', 'shadow-lg');
                    tabLogin.classList.add('text-gray-400');
                    registerForm.classList.remove('hidden');
                    loginForm.classList.add('hidden');
                });

                document.getElementById('btn-login')?.addEventListener('click', async () => {
                    const email = document.getElementById('login-email').value;
                    const password = document.getElementById('login-password').value;

                    if (!email || !password) {
                        Notifier.show('Por favor complete todos los campos', 'error');
                        return;
                    }

                    Loader.show();
                    const user = await DataManager.login(email, password);
                    Loader.hide();

                    if (user) {
                        this.currentUser = user;
                        this.currentView = 'home';
                        Notifier.show('¬°Bienvenido!', 'success');
                        await this.render();
                    } else {
                        Notifier.show('Email o contrase√±a incorrectos', 'error');
                    }
                });

                document.getElementById('btn-register')?.addEventListener('click', async () => {
                    const nombre = document.getElementById('register-nombre').value;
                    const email = document.getElementById('register-email').value;
                    const password = document.getElementById('register-password').value;

                    if (!nombre || !email || !password) {
                        Notifier.show('Por favor complete todos los campos', 'error');
                        return;
                    }

                    Loader.show();
                    const result = await DataManager.register(email, password, nombre);
                    Loader.hide();

                    if (result.success) {
                        Notifier.show(result.message, 'success');
                        tabLogin.click();
                    } else {
                        Notifier.show(result.message, 'error');
                    }
                });
            }

            attachDashboardEvents() {
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', async (e) => {
                        this.currentView = e.currentTarget.dataset.view;
                        await this.render();
                    });
                });

                document.getElementById('btn-logout')?.addEventListener('click', async () => {
                    await DataManager.logout();
                    this.currentUser = null;
                    this.currentView = 'login';
                    Notifier.show('Sesi√≥n cerrada', 'info');
                    await this.render();
                });

                // Eventos espec√≠ficos por vista
                if (this.currentView === 'servicios') {
                    this.attachServiciosEvents();
                } else if (this.currentView === 'inventario') {
                    this.attachInventarioEvents();
                } else if (this.currentView === 'reservar') {
                    this.attachReservarEvents();
                } else if (this.currentView === 'mis-citas') {
                    this.attachMisCitasEvents();
                }
            }

            attachServiciosEvents() {
                document.getElementById('btn-add-servicio')?.addEventListener('click', () => {
                    this.showServicioModal();
                });

                document.querySelectorAll('.btn-edit-servicio').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const id = e.currentTarget.dataset.id;
                        const servicios = await DataManager.getServicios();
                        const servicio = servicios.find(s => s.id === id);
                        this.showServicioModal(servicio);
                    });
                });

                document.querySelectorAll('.btn-delete-servicio').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const id = e.currentTarget.dataset.id;
                        this.showConfirmModal('¬øEliminar este servicio?', async () => {
                            Loader.show();
                            const success = await DataManager.deleteServicio(id);
                            Loader.hide();
                            if (success) {
                                Notifier.show('Servicio eliminado', 'success');
                                await this.render();
                            } else {
                                Notifier.show('Error al eliminar', 'error');
                            }
                        });
                    });
                });
            }

            attachInventarioEvents() {
                document.getElementById('btn-add-inventario')?.addEventListener('click', () => {
                    this.showInventarioModal();
                });

                document.querySelectorAll('.btn-edit-inventario').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const id = e.currentTarget.dataset.id;
                        const items = await DataManager.getInventario();
                        const item = items.find(i => i.id === id);
                        this.showInventarioModal(item);
                    });
                });

                document.querySelectorAll('.btn-delete-inventario').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const id = e.currentTarget.dataset.id;
                        this.showConfirmModal('¬øEliminar este producto?', async () => {
                            Loader.show();
                            const { error } = await supabase.from('inventario').delete().eq('id', id);
                            Loader.hide();
                            if (!error) {
                                Notifier.show('Producto eliminado', 'success');
                                await this.render();
                            } else {
                                Notifier.show('Error al eliminar', 'error');
                            }
                        });
                    });
                });
            }

            attachReservarEvents() {
                const selectServicio = document.getElementById('select-servicio');
                const inputFecha = document.getElementById('input-fecha');
                const horariosDiv = document.getElementById('horarios-disponibles');
                const btnConfirmar = document.getElementById('btn-confirmar-reserva');
                let selectedSlot = null;

                const today = new Date().toISOString().split('T')[0];
                inputFecha.min = today;

                const updateSlots = async () => {
                    const servicioId = selectServicio.value;
                    const fecha = inputFecha.value;

                    if (!servicioId || !fecha) {
                        horariosDiv.classList.add('hidden');
                        btnConfirmar.disabled = true;
                        return;
                    }

                    const servicios = await DataManager.getServicios();
                    const servicio = servicios.find(s => s.id === servicioId);
                    if (!servicio) return;

                    const slots = await this.calcularSlotsDisponibles(fecha, servicio.duracion);
                    const slotsContainer = document.getElementById('slots-container');
                    slotsContainer.innerHTML = '';

                    if (slots.length === 0) {
                        slotsContainer.innerHTML = '<p class="col-span-full text-center text-gray-500">No hay horarios disponibles</p>';
                        horariosDiv.classList.remove('hidden');
                        btnConfirmar.disabled = true;
                        return;
                    }

                    slots.forEach(slot => {
                        const btn = document.createElement('button');
                        btn.className = 'px-4 py-2 rounded-lg border-2 border-primary/30 hover:border-primary hover:bg-primary/10 transition-all font-medium';
                        btn.textContent = slot;
                        btn.addEventListener('click', () => {
                            slotsContainer.querySelectorAll('button').forEach(b => {
                                b.className = 'px-4 py-2 rounded-lg border-2 border-primary/30 hover:border-primary hover:bg-primary/10 transition-all font-medium';
                            });
                            btn.className = 'px-4 py-2 rounded-lg border-2 border-primary bg-primary text-dark transition-all font-bold';
                            selectedSlot = slot;
                            btnConfirmar.disabled = false;
                        });
                        slotsContainer.appendChild(btn);
                    });

                    horariosDiv.classList.remove('hidden');
                };

                selectServicio?.addEventListener('change', updateSlots);
                inputFecha?.addEventListener('change', updateSlots);

                btnConfirmar?.addEventListener('click', async () => {
                    const servicioId = selectServicio.value;
                    const fecha = inputFecha.value;

                    if (!servicioId || !fecha || !selectedSlot) return;

                    const [hora, minuto] = selectedSlot.split(':');
                    const fechaHora = new Date(fecha);
                    fechaHora.setHours(parseInt(hora), parseInt(minuto), 0, 0);

                    const nuevaCita = {
                        cliente_id: this.currentUser.id,
                        servicio_id: servicioId,
                        barbero_id: null,
                        fecha_hora: fechaHora.toISOString(),
                        estado_asignacion: 'PENDIENTE'
                    };

                    Loader.show();
                    const success = await DataManager.saveCita(nuevaCita);
                    Loader.hide();

                    if (success) {
                        Notifier.show('¬°Cita reservada exitosamente!', 'success');
                        setTimeout(async () => {
                            this.currentView = 'mis-citas';
                            await this.render();
                        }, 1500);
                    } else {
                        Notifier.show('Error al reservar cita', 'error');
                    }
                });
            }

            attachMisCitasEvents() {
                document.querySelectorAll('.btn-cancelar-cita').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const id = e.currentTarget.dataset.id;
                        this.showConfirmModal('¬øCancelar esta cita?', async () => {
                            Loader.show();
                            const { error } = await supabase.from('citas').delete().eq('id', id);
                            Loader.hide();
                            if (!error) {
                                Notifier.show('Cita cancelada', 'success');
                                await this.render();
                            } else {
                                Notifier.show('Error al cancelar', 'error');
                            }
                        });
                    });
                });

                document.querySelectorAll('.btn-pagar-cita').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const precio = e.currentTarget.dataset.precio;
                        this.procesarPago(precio);
                    });
                });
            }

            // ========================================
            // UTILIDADES
            // ========================================
            async calcularSlotsDisponibles(fecha, duracion) {
                const slots = [];
                const horaInicio = 9;
                const horaFin = 19;
                const intervalo = 30;

                for (let hora = horaInicio; hora < horaFin; hora++) {
                    for (let minuto = 0; minuto < 60; minuto += intervalo) {
                        const finSlot = hora + (minuto + duracion) / 60;
                        if (finSlot <= horaFin) {
                            slots.push(`${hora.toString().padStart(2, '0')}:${minuto.toString().padStart(2, '0')}`);
                        }
                    }
                }

                const citas = await DataManager.getCitas();
                const citasFecha = citas.filter(c => {
                    const fechaCita = new Date(c.fecha_hora);
                    const fechaSeleccionada = new Date(fecha);
                    return fechaCita.toDateString() === fechaSeleccionada.toDateString() && c.estado_asignacion === 'ASIGNADO';
                });

                return slots.filter(slot => {
                    const [hora, minuto] = slot.split(':');
                    const inicioSlot = new Date(fecha);
                    inicioSlot.setHours(parseInt(hora), parseInt(minuto), 0, 0);
                    const finSlot = new Date(inicioSlot.getTime() + duracion * 60000);

                    return !citasFecha.some(c => {
                        const inicioCita = new Date(c.fecha_hora);
                        const duracionCita = c.servicio?.duracion || 30;
                        const finCita = new Date(inicioCita.getTime() + duracionCita * 60000);
                        return (inicioSlot < finCita && finSlot > inicioCita);
                    });
                });
            }

            procesarPago(precio) {
                Notifier.show('Procesando pago...', 'info');
                setTimeout(() => {
                    Notifier.show('¬°Pago exitoso! Gracias.', 'success');
                }, 2000);
            }

            showServicioModal(servicio = null) {
                const isEdit = !!servicio;
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 px-4';
                modal.innerHTML = `
                    <div class="bg-dark-card border border-primary/20 rounded-xl shadow-2xl p-8 w-full max-w-md slide-in glow-strong">
                        <h3 class="text-2xl font-display font-bold mb-6 gradient-gold text-transparent bg-clip-text">${isEdit ? 'Editar' : 'Nuevo'} Servicio</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2 text-gray-300">Nombre</label>
                                <input type="text" id="modal-nombre" class="w-full px-4 py-3 rounded-lg bg-dark-lighter border border-primary/30 focus:border-primary text-white" value="${servicio?.nombre || ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2 text-gray-300">Duraci√≥n (min)</label>
                                <input type="number" id="modal-duracion" class="w-full px-4 py-3 rounded-lg bg-dark-lighter border border-primary/30 focus:border-primary text-white" value="${servicio?.duracion || 30}" min="15" step="15">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2 text-gray-300">Precio ($)</label>
                                <input type="number" id="modal-precio" class="w-full px-4 py-3 rounded-lg bg-dark-lighter border border-primary/30 focus:border-primary text-white" value="${servicio?.precio || 20}" min="1">
                            </div>
                            <div class="flex space-x-3 pt-4">
                                <button id="modal-cancel" class="flex-1 px-4 py-3 bg-dark-lighter border border-primary/20 text-gray-300 rounded-lg hover:bg-dark transition-all font-medium">
                                    Cancelar
                                </button>
                                <button id="modal-save" class="flex-1 px-4 py-3 gradient-gold text-dark rounded-lg font-bold transition-all shadow-lg hover:shadow-xl">
                                    ${isEdit ? 'Guardar' : 'Crear'}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                modal.querySelector('#modal-cancel').addEventListener('click', () => modal.remove());
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.remove();
                });

                modal.querySelector('#modal-save').addEventListener('click', async () => {
                    const nombre = modal.querySelector('#modal-nombre').value.trim();
                    const duracion = parseInt(modal.querySelector('#modal-duracion').value);
                    const precio = parseFloat(modal.querySelector('#modal-precio').value);

                    if (!nombre || !duracion || !precio) {
                        Notifier.show('Complete todos los campos', 'error');
                        return;
                    }

                    const servicioData = { nombre, duracion, precio };
                    if (isEdit) servicioData.id = servicio.id;

                    Loader.show();
                    const success = await DataManager.saveServicio(servicioData);
                    Loader.hide();

                    if (success) {
                        Notifier.show(isEdit ? 'Servicio actualizado' : 'Servicio creado', 'success');
                        modal.remove();
                        await this.render();
                    } else {
                        Notifier.show('Error al guardar', 'error');
                    }
                });
            }

            showInventarioModal(item = null) {
                const isEdit = !!item;
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 px-4';
                modal.innerHTML = `
                    <div class="bg-dark-card border border-primary/20 rounded-xl shadow-2xl p-8 w-full max-w-md slide-in glow-strong">
                        <h3 class="text-2xl font-display font-bold mb-6 gradient-gold text-transparent bg-clip-text">${isEdit ? 'Editar' : 'Nuevo'} Producto</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2 text-gray-300">Nombre</label>
                                <input type="text" id="modal-nombre" class="w-full px-4 py-3 rounded-lg bg-dark-lighter border border-primary/30 text-white" value="${item?.nombre || ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2 text-gray-300">Descripci√≥n</label>
                                <input type="text" id="modal-desc" class="w-full px-4 py-3 rounded-lg bg-dark-lighter border border-primary/30 text-white" value="${item?.descripcion || ''}">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-gray-300">Cantidad</label>
                                    <input type="number" id="modal-cantidad" class="w-full px-4 py-3 rounded-lg bg-dark-lighter border border-primary/30 text-white" value="${item?.cantidad || 0}" min="0">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2 text-gray-300">M√≠nimo</label>
                                    <input type="number" id="modal-minimo" class="w-full px-4 py-3 rounded-lg bg-dark-lighter border border-primary/30 text-white" value="${item?.minimo || 5}" min="1">
                                </div>
                            </div>
                            <div class="flex space-x-3 pt-4">
                                <button id="modal-cancel" class="flex-1 px-4 py-3 bg-dark-lighter border border-primary/20 text-gray-300 rounded-lg font-medium">Cancelar</button>
                                <button id="modal-save" class="flex-1 px-4 py-3 gradient-gold text-dark rounded-lg font-bold">${isEdit ? 'Guardar' : 'Crear'}</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                modal.querySelector('#modal-cancel').addEventListener('click', () => modal.remove());
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.remove();
                });

                modal.querySelector('#modal-save').addEventListener('click', async () => {
                    const nombre = modal.querySelector('#modal-nombre').value.trim();
                    const descripcion = modal.querySelector('#modal-desc').value.trim();
                    const cantidad = parseInt(modal.querySelector('#modal-cantidad').value);
                    const minimo = parseInt(modal.querySelector('#modal-minimo').value);

                    if (!nombre) {
                        Notifier.show('Ingrese el nombre', 'error');
                        return;
                    }

                    const itemData = { nombre, descripcion, cantidad, minimo };
                    if (isEdit) itemData.id = item.id;

                    Loader.show();
                    const success = await DataManager.saveInventario(itemData);
                    Loader.hide();

                    if (success) {
                        Notifier.show(isEdit ? 'Producto actualizado' : 'Producto creado', 'success');
                        modal.remove();
                        await this.render();
                    } else {
                        Notifier.show('Error al guardar', 'error');
                    }
                });
            }

            showConfirmModal(message, onConfirm) {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 px-4';
                modal.innerHTML = `
                    <div class="bg-dark-card border border-primary/20 rounded-xl shadow-2xl p-8 w-full max-w-md slide-in glow-strong">
                        <h3 class="text-xl font-display font-bold mb-4 text-primary">Confirmar Acci√≥n</h3>
                        <p class="text-gray-300 mb-6">${message}</p>
                        <div class="flex space-x-3">
                            <button id="modal-cancel" class="flex-1 px-4 py-3 bg-dark-lighter border border-primary/20 text-gray-300 rounded-lg font-medium">
                                Cancelar
                            </button>
                            <button id="modal-confirm" class="flex-1 px-4 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg font-bold transition-all">
                                Confirmar
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                modal.querySelector('#modal-cancel').addEventListener('click', () => modal.remove());
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.remove();
                });

                modal.querySelector('#modal-confirm').addEventListener('click', () => {
                    onConfirm();
                    modal.remove();
                });
            }
        }

        // ========================================
        // INICIALIZACI√ìN
        // ========================================
        document.addEventListener('DOMContentLoaded', () => {
            new App();
        });
    </script>
</body>
</html>