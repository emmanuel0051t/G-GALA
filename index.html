<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barber√≠a Pro - Sistema de Gesti√≥n de Citas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                    }
                }
            }
        }
    </script>
    <style>
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="bg-white dark:bg-[#181818] text-gray-900 dark:text-gray-100 transition-colors min-h-screen">
    <div id="app"></div>

    <script>
        // ========================================
        // 1. CONFIGURACI√ìN DE DARK MODE
        // ========================================
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // ========================================
        // 2. GESTI√ìN DE DATOS (Almacenamiento en Memoria)
        // ========================================
        const AppStorage = {
            users: [
                {
                    id: '1',
                    email: 'admin@barberia.com',
                    password: 'admin123', // En producci√≥n usar BCrypt
                    nombre: 'Administrador',
                    rol: 'ADMIN'
                },
                {
                    id: '2',
                    email: 'cliente@test.com',
                    password: 'cliente123',
                    nombre: 'Juan P√©rez',
                    rol: 'CLIENTE'
                }
            ],
            servicios: [
                { id: '1', nombre: 'Corte Cl√°sico', duracion: 30, precio: 15 },
                { id: '2', nombre: 'Corte + Barba', duracion: 45, precio: 25 },
                { id: '3', nombre: 'Afeitado Tradicional', duracion: 30, precio: 20 }
            ],
            barberos: [],
            citas: [],
            currentUser: null
        };

        class DataManager {
            static initializeData() {
                // Datos ya inicializados en AppStorage
            }

            static getUsers() {
                return AppStorage.users;
            }

            static setUsers(users) {
                AppStorage.users = users;
            }

            static getServicios() {
                return AppStorage.servicios;
            }

            static setServicios(servicios) {
                AppStorage.servicios = servicios;
            }

            static getBarberos() {
                return AppStorage.barberos;
            }

            static setBarberos(barberos) {
                AppStorage.barberos = barberos;
            }

            static getCitas() {
                return AppStorage.citas;
            }

            static setCitas(citas) {
                AppStorage.citas = citas;
            }

            static getCurrentUser() {
                return AppStorage.currentUser;
            }

            static login(email, password) {
                const users = this.getUsers();
                const user = users.find(u => u.email === email && u.password === password);
                if (user) {
                    // Guardar usuario actual en memoria
                    AppStorage.currentUser = {
                        id: user.id,
                        email: user.email,
                        nombre: user.nombre,
                        rol: user.rol
                    };
                    return true;
                }
                return false;
            }

            static register(email, password, nombre) {
                const users = this.getUsers();
                if (users.find(u => u.email === email)) {
                    return { success: false, message: 'El email ya est√° registrado' };
                }
                const newUser = {
                    id: Date.now().toString(),
                    email,
                    password,
                    nombre,
                    rol: 'CLIENTE'
                };
                users.push(newUser);
                this.setUsers(users);
                return { success: true, message: 'Usuario registrado exitosamente' };
            }

            static logout() {
                AppStorage.currentUser = null;
            }
        }

        // ========================================
        // 3. COMPONENTES UI
        // ========================================
        class App {
            constructor() {
                DataManager.initializeData();
                this.currentView = 'login';
                this.render();
            }

            render() {
                const user = DataManager.getCurrentUser();
                const appDiv = document.getElementById('app');

                if (!user) {
                    appDiv.innerHTML = this.renderLogin();
                    this.attachLoginEvents();
                } else {
                    appDiv.innerHTML = this.renderDashboard(user);
                    this.attachDashboardEvents(user);
                }
            }

            renderLogin() {
                return `
                    <div class="min-h-screen flex items-center justify-center px-4 bg-gradient-to-br from-primary/10 to-purple-100 dark:from-primary/20 dark:to-purple-900/20">
                        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-8 w-full max-w-md fade-in">
                            <div class="text-center mb-8">
                                <h1 class="text-4xl font-bold text-primary mb-2">‚úÇÔ∏è Barber√≠a Pro</h1>
                                <p class="text-gray-600 dark:text-gray-400">Sistema de Gesti√≥n de Citas</p>
                            </div>

                            <div class="mb-6">
                                <div class="flex rounded-lg bg-gray-100 dark:bg-gray-700 p-1">
                                    <button id="tab-login" class="flex-1 py-2 px-4 rounded-md text-base font-medium transition-all bg-white dark:bg-gray-600 text-primary shadow">
                                        Iniciar Sesi√≥n
                                    </button>
                                    <button id="tab-register" class="flex-1 py-2 px-4 rounded-md text-base font-medium transition-all text-gray-600 dark:text-gray-300">
                                        Registrarse
                                    </button>
                                </div>
                            </div>

                            <!-- Login Form -->
                            <div id="login-form">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Email</label>
                                        <input type="email" id="login-email" class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-transparent transition-all" placeholder="tu@email.com" value="admin@barberia.com">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Contrase√±a</label>
                                        <input type="password" id="login-password" class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-transparent transition-all" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" value="admin123">
                                    </div>
                                    <div id="login-error" class="hidden text-red-500 text-sm"></div>
                                    <button id="btn-login" class="w-full bg-primary hover:bg-primary/90 text-white font-semibold py-3 px-6 rounded-lg transition-all shadow-lg hover:shadow-xl">
                                        Iniciar Sesi√≥n
                                    </button>
                                </div>

                                <div class="mt-6 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                                    <p class="text-sm font-semibold mb-2">Usuarios de prueba:</p>
                                    <p class="text-xs text-gray-600 dark:text-gray-400">
                                        <strong>Admin:</strong> admin@barberia.com / admin123<br>
                                        <strong>Cliente:</strong> cliente@test.com / cliente123
                                    </p>
                                </div>
                            </div>

                            <!-- Register Form -->
                            <div id="register-form" class="hidden">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Nombre Completo</label>
                                        <input type="text" id="register-nombre" class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-transparent transition-all" placeholder="Juan P√©rez">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Email</label>
                                        <input type="email" id="register-email" class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-transparent transition-all" placeholder="tu@email.com">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Contrase√±a</label>
                                        <input type="password" id="register-password" class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-transparent transition-all" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                                    </div>
                                    <div id="register-error" class="hidden text-red-500 text-sm"></div>
                                    <div id="register-success" class="hidden text-green-500 text-sm"></div>
                                    <button id="btn-register" class="w-full bg-primary hover:bg-primary/90 text-white font-semibold py-3 px-6 rounded-lg transition-all shadow-lg hover:shadow-xl">
                                        Crear Cuenta
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderDashboard(user) {
                const navigation = this.renderNavigation(user);
                let content = '';

                switch(this.currentView) {
                    case 'servicios':
                        content = this.renderServicios();
                        break;
                    case 'barberos':
                        content = this.renderBarberos();
                        break;
                    case 'reservar':
                        content = this.renderReservar();
                        break;
                    case 'mis-citas':
                        content = this.renderMisCitas(user);
                        break;
                    case 'asignar-citas':
                        content = this.renderAsignarCitas();
                        break;
                    case 'citas-barbero':
                        content = this.renderCitasBarbero(user);
                        break;
                    default:
                        content = this.renderHome(user);
                }

                return `
                    <div class="min-h-screen bg-gray-50 dark:bg-[#181818]">
                        ${navigation}
                        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                            ${content}
                        </main>
                    </div>
                `;
            }

            renderNavigation(user) {
                const menuItems = [];

                menuItems.push({ name: 'Inicio', view: 'home', icon: 'üè†' });

                if (user.rol === 'ADMIN') {
                    menuItems.push({ name: 'Servicios', view: 'servicios', icon: '‚úÇÔ∏è' });
                    menuItems.push({ name: 'Barberos', view: 'barberos', icon: 'üë®‚Äçüíº' });
                    menuItems.push({ name: 'Asignar Citas', view: 'asignar-citas', icon: 'üìã' });
                } else if (user.rol === 'CLIENTE') {
                    menuItems.push({ name: 'Reservar Cita', view: 'reservar', icon: 'üìÖ' });
                    menuItems.push({ name: 'Mis Citas', view: 'mis-citas', icon: 'üìã' });
                } else if (user.rol === 'BARBERO') {
                    menuItems.push({ name: 'Mis Citas', view: 'citas-barbero', icon: 'üìã' });
                }

                return `
                    <nav class="bg-white dark:bg-gray-800 shadow-lg">
                        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div class="flex justify-between items-center h-16">
                                <div class="flex items-center space-x-8">
                                    <h1 class="text-2xl font-bold text-primary">‚úÇÔ∏è Barber√≠a Pro</h1>
                                    <div class="hidden md:flex space-x-4">
                                        ${menuItems.map(item => `
                                            <button class="nav-item px-4 py-2 rounded-lg text-base font-medium transition-all ${this.currentView === item.view ? 'bg-primary text-white' : 'text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700'}" data-view="${item.view}">
                                                ${item.icon} ${item.name}
                                            </button>
                                        `).join('')}
                                    </div>
                                </div>
                                <div class="flex items-center space-x-4">
                                    <div class="text-right">
                                        <p class="text-sm font-medium">${user.nombre}</p>
                                        <p class="text-xs text-gray-500 dark:text-gray-400">${user.rol}</p>
                                    </div>
                                    <button id="btn-logout" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-all text-base">
                                        Salir
                                    </button>
                                </div>
                            </div>
                        </div>
                    </nav>
                `;
            }

            renderHome(user) {
                const servicios = DataManager.getServicios();
                const barberos = DataManager.getBarberos();
                const citas = DataManager.getCitas();

                return `
                    <div class="fade-in">
                        <h2 class="text-3xl font-bold mb-8">Bienvenido, ${user.nombre}</h2>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-gray-500 dark:text-gray-400 text-sm">Servicios</p>
                                        <p class="text-3xl font-bold text-primary">${servicios.length}</p>
                                    </div>
                                    <div class="text-5xl">‚úÇÔ∏è</div>
                                </div>
                            </div>
                            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-gray-500 dark:text-gray-400 text-sm">Barberos</p>
                                        <p class="text-3xl font-bold text-primary">${barberos.length}</p>
                                    </div>
                                    <div class="text-5xl">üë®‚Äçüíº</div>
                                </div>
                            </div>
                            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-gray-500 dark:text-gray-400 text-sm">Citas</p>
                                        <p class="text-3xl font-bold text-primary">${citas.length}</p>
                                    </div>
                                    <div class="text-5xl">üìÖ</div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-gradient-to-r from-primary to-purple-600 rounded-xl shadow-lg p-8 text-white">
                            <h3 class="text-2xl font-bold mb-4">Nuestros Servicios</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                ${servicios.map(s => `
                                    <div class="bg-white/10 backdrop-blur rounded-lg p-4">
                                        <h4 class="font-semibold mb-2">${s.nombre}</h4>
                                        <p class="text-sm opacity-90">‚è±Ô∏è ${s.duracion} min | üí∞ $${s.precio}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }

            renderServicios() {
                const servicios = DataManager.getServicios();
                return `
                    <div class="fade-in">
                        <div class="flex justify-between items-center mb-8">
                            <h2 class="text-3xl font-bold">Gesti√≥n de Servicios</h2>
                            <button id="btn-add-servicio" class="px-6 py-3 bg-primary hover:bg-primary/90 text-white rounded-lg transition-all shadow-lg text-base font-medium">
                                + Nuevo Servicio
                            </button>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            ${servicios.map(s => `
                                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 hover:shadow-xl transition-all">
                                    <div class="flex justify-between items-start mb-4">
                                        <div>
                                            <h3 class="text-xl font-bold mb-2">${s.nombre}</h3>
                                            <div class="space-y-1">
                                                <p class="text-gray-600 dark:text-gray-400">‚è±Ô∏è Duraci√≥n: ${s.duracion} min</p>
                                                <p class="text-primary font-bold text-lg">üí∞ $${s.precio}</p>
                                            </div>
                                        </div>
                                        <div class="flex space-x-2">
                                            <button class="btn-edit-servicio p-2 text-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded-lg transition-all" data-id="${s.id}">‚úèÔ∏è</button>
                                            <button class="btn-delete-servicio p-2 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-all" data-id="${s.id}">üóëÔ∏è</button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            renderBarberos() {
                const barberos = DataManager.getBarberos();
                const users = DataManager.getUsers();

                return `
                    <div class="fade-in">
                        <div class="flex justify-between items-center mb-8">
                            <h2 class="text-3xl font-bold">Gesti√≥n de Barberos</h2>
                            <button id="btn-add-barbero" class="px-6 py-3 bg-primary hover:bg-primary/90 text-white rounded-lg transition-all shadow-lg text-base font-medium">
                                + Nuevo Barbero
                            </button>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            ${barberos.map(b => {
                                const user = users.find(u => u.id === b.usuario_id);
                                return `
                                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 hover:shadow-xl transition-all">
                                        <div class="flex justify-between items-start mb-4">
                                            <div class="flex-1">
                                                <div class="w-16 h-16 bg-primary/10 rounded-full flex items-center justify-center text-3xl mb-3">
                                                    üë®‚Äçüíº
                                                </div>
                                                <h3 class="text-xl font-bold mb-2">${user ? user.nombre : 'Usuario no encontrado'}</h3>
                                                <div class="space-y-1">
                                                    <p class="text-gray-600 dark:text-gray-400 text-sm">üìß ${user ? user.email : ''}</p>
                                                    <p class="text-gray-600 dark:text-gray-400 text-sm">üïê ${b.horario_inicio} - ${b.horario_fin}</p>
                                                </div>
                                            </div>
                                            <div class="flex space-x-2">
                                                <button class="btn-edit-barbero p-2 text-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded-lg transition-all" data-id="${b.id}">‚úèÔ∏è</button>
                                                <button class="btn-delete-barbero p-2 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-all" data-id="${b.id}">üóëÔ∏è</button>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }

            renderReservar() {
                const servicios = DataManager.getServicios();
                return `
                    <div class="fade-in max-w-2xl mx-auto">
                        <h2 class="text-3xl font-bold mb-8">Reservar Cita</h2>

                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-8">
                            <div class="space-y-6">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Servicio</label>
                                    <select id="select-servicio" class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-transparent transition-all">
                                        <option value="">Seleccione un servicio</option>
                                        ${servicios.map(s => `
                                            <option value="${s.id}" data-duracion="${s.duracion}">${s.nombre} - $${s.precio} (${s.duracion} min)</option>
                                        `).join('')}
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium mb-2">Fecha</label>
                                    <input type="date" id="input-fecha" class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-transparent transition-all">
                                </div>

                                <div id="horarios-disponibles" class="hidden">
                                    <label class="block text-sm font-medium mb-2">Horarios Disponibles</label>
                                    <div id="slots-container" class="grid grid-cols-3 sm:grid-cols-4 gap-3"></div>
                                </div>

                                <div id="reserva-error" class="hidden text-red-500 text-sm"></div>
                                <div id="reserva-success" class="hidden text-green-500 text-sm"></div>

                                <button id="btn-confirmar-reserva" class="w-full bg-primary hover:bg-primary/90 text-white font-semibold py-3 px-6 rounded-lg transition-all shadow-lg text-base disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                    Confirmar Reserva
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderMisCitas(user) {
                const citas = DataManager.getCitas().filter(c => c.cliente_id === user.id);
                const servicios = DataManager.getServicios();
                const barberos = DataManager.getBarberos();
                const users = DataManager.getUsers();

                return `
                    <div class="fade-in">
                        <h2 class="text-3xl font-bold mb-8">Mis Citas</h2>

                        ${citas.length === 0 ? `
                            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-12 text-center">
                                <div class="text-6xl mb-4">üìÖ</div>
                                <h3 class="text-xl font-semibold mb-2">No tienes citas programadas</h3>
                                <p class="text-gray-600 dark:text-gray-400 mb-6">¬°Agenda tu primera cita ahora!</p>
                                <button class="nav-item px-6 py-3 bg-primary hover:bg-primary/90 text-white rounded-lg transition-all text-base font-medium" data-view="reservar">
                                    Reservar Cita
                                </button>
                            </div>
                        ` : `
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                ${citas.map(c => {
                                    const servicio = servicios.find(s => s.id === c.servicio_id);
                                    const barbero = barberos.find(b => b.id === c.barbero_id);
                                    const barberoUser = barbero ? users.find(u => u.id === barbero.usuario_id) : null;
                                    const fecha = new Date(c.fecha_hora);
                                    const ahora = new Date();
                                    const isPast = fecha < ahora;

                                    return `
                                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 ${isPast ? 'opacity-60' : ''}">
                                            <div class="flex justify-between items-start mb-4">
                                                <div class="flex-1">
                                                    <div class="flex items-center space-x-2 mb-2">
                                                        <span class="px-3 py-1 rounded-full text-xs font-semibold ${c.estado_asignacion === 'ASIGNADO' ? 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400' : 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400'}">
                                                            ${c.estado_asignacion}
                                                        </span>
                                                        ${isPast ? '<span class="px-3 py-1 rounded-full text-xs font-semibold bg-gray-100 text-gray-800 dark:bg-gray-900/30 dark:text-gray-400">PASADA</span>' : ''}
                                                    </div>
                                                    <h3 class="text-xl font-bold mb-2">${servicio ? servicio.nombre : 'Servicio eliminado'}</h3>
                                                    <div class="space-y-1 text-sm">
                                                        <p class="text-gray-600 dark:text-gray-400">üìÖ ${fecha.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                                                        <p class="text-gray-600 dark:text-gray-400">üïê ${fecha.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })}</p>
                                                        ${barberoUser ? `<p class="text-gray-600 dark:text-gray-400">üë®‚Äçüíº Barbero: ${barberoUser.nombre}</p>` : '<p class="text-gray-600 dark:text-gray-400">üë®‚Äçüíº Barbero: Por asignar</p>'}
                                                        ${servicio ? `<p class="text-primary font-bold">üí∞ $${servicio.precio}</p>` : ''}
                                                    </div>
                                                </div>
                                            </div>
                                            ${!isPast ? `
                                                <button class="btn-cancelar-cita w-full mt-4 px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-all text-base" data-id="${c.id}">
                                                    Cancelar Cita
                                                </button>
                                            ` : ''}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `}
                    </div>
                `;
            }

            renderAsignarCitas() {
                const citas = DataManager.getCitas().filter(c => c.estado_asignacion === 'PENDIENTE');
                const servicios = DataManager.getServicios();
                const barberos = DataManager.getBarberos();
                const users = DataManager.getUsers();

                return `
                    <div class="fade-in">
                        <h2 class="text-3xl font-bold mb-8">Asignar Barberos a Citas Pendientes</h2>

                        ${citas.length === 0 ? `
                            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-12 text-center">
                                <div class="text-6xl mb-4">‚úÖ</div>
                                <h3 class="text-xl font-semibold mb-2">No hay citas pendientes de asignar</h3>
                                <p class="text-gray-600 dark:text-gray-400">Todas las citas tienen un barbero asignado.</p>
                            </div>
                        ` : `
                            <div class="space-y-6">
                                ${citas.map(c => {
                                    const servicio = servicios.find(s => s.id === c.servicio_id);
                                    const cliente = users.find(u => u.id === c.cliente_id);
                                    const fecha = new Date(c.fecha_hora);

                                    return `
                                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                <div>
                                                    <h3 class="text-xl font-bold mb-4">Informaci√≥n de la Cita</h3>
                                                    <div class="space-y-2 text-sm">
                                                        <p><strong>Cliente:</strong> ${cliente ? cliente.nombre : 'Desconocido'}</p>
                                                        <p><strong>Servicio:</strong> ${servicio ? servicio.nombre : 'Desconocido'}</p>
                                                        <p><strong>Duraci√≥n:</strong> ${servicio ? servicio.duracion : 0} min</p>
                                                        <p><strong>Fecha:</strong> ${fecha.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                                                        <p><strong>Hora:</strong> ${fecha.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })}</p>
                                                    </div>
                                                </div>
                                                <div>
                                                    <h3 class="text-xl font-bold mb-4">Asignar Barbero</h3>
                                                    <select class="select-barbero-asignar w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary focus:border-transparent transition-all mb-3" data-cita-id="${c.id}">
                                                        <option value="">Seleccione un barbero</option>
                                                        ${barberos.map(b => {
                                                            const barberoUser = users.find(u => u.id === b.usuario_id);
                                                            return `<option value="${b.id}">${barberoUser ? barberoUser.nombre : 'Desconocido'}</option>`;
                                                        }).join('')}
                                                    </select>
                                                    <div class="asignar-error-${c.id} hidden text-red-500 text-sm mb-2"></div>
                                                    <button class="btn-asignar w-full px-4 py-2 bg-primary hover:bg-primary/90 text-white rounded-lg transition-all text-base disabled:opacity-50" data-cita-id="${c.id}" disabled>
                                                        Asignar Barbero
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `}
                    </div>
                `;
            }

            renderCitasBarbero(user) {
                const barberos = DataManager.getBarberos();
                const barbero = barberos.find(b => b.usuario_id === user.id);

                if (!barbero) {
                    return `
                        <div class="fade-in">
                            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-12 text-center">
                                <div class="text-6xl mb-4">‚ùå</div>
                                <h3 class="text-xl font-semibold mb-2">No est√°s registrado como barbero</h3>
                                <p class="text-gray-600 dark:text-gray-400">Contacta al administrador para obtener acceso.</p>
                            </div>
                        </div>
                    `;
                }

                const citas = DataManager.getCitas().filter(c => c.barbero_id === barbero.id && c.estado_asignacion === 'ASIGNADO');
                const servicios = DataManager.getServicios();
                const users = DataManager.getUsers();

                return `
                    <div class="fade-in">
                        <h2 class="text-3xl font-bold mb-8">Mis Citas Asignadas</h2>

                        ${citas.length === 0 ? `
                            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-12 text-center">
                                <div class="text-6xl mb-4">üìÖ</div>
                                <h3 class="text-xl font-semibold mb-2">No tienes citas asignadas</h3>
                                <p class="text-gray-600 dark:text-gray-400">Espera a que el administrador te asigne citas.</p>
                            </div>
                        ` : `
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                ${citas.map(c => {
                                    const servicio = servicios.find(s => s.id === c.servicio_id);
                                    const cliente = users.find(u => u.id === c.cliente_id);
                                    const fecha = new Date(c.fecha_hora);
                                    const ahora = new Date();
                                    const isPast = fecha < ahora;

                                    return `
                                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 ${isPast ? 'opacity-60' : ''}">
                                            <div class="flex justify-between items-start mb-4">
                                                <div class="flex-1">
                                                    ${isPast ? '<span class="px-3 py-1 rounded-full text-xs font-semibold bg-gray-100 text-gray-800 dark:bg-gray-900/30 dark:text-gray-400 mb-2 inline-block">PASADA</span>' : ''}
                                                    <h3 class="text-xl font-bold mb-2">${servicio ? servicio.nombre : 'Servicio eliminado'}</h3>
                                                    <div class="space-y-1 text-sm">
                                                        <p class="text-gray-600 dark:text-gray-400">üë§ Cliente: ${cliente ? cliente.nombre : 'Desconocido'}</p>
                                                        <p class="text-gray-600 dark:text-gray-400">üìÖ ${fecha.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                                                        <p class="text-gray-600 dark:text-gray-400">üïê ${fecha.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })}</p>
                                                        <p class="text-gray-600 dark:text-gray-400">‚è±Ô∏è Duraci√≥n: ${servicio ? servicio.duracion : 0} min</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `}
                    </div>
                `;
            }

            // ========================================
            // EVENT HANDLERS
            // ========================================
            attachLoginEvents() {
                const tabLogin = document.getElementById('tab-login');
                const tabRegister = document.getElementById('tab-register');
                const loginForm = document.getElementById('login-form');
                const registerForm = document.getElementById('register-form');

                tabLogin.addEventListener('click', () => {
                    tabLogin.classList.add('bg-white', 'dark:bg-gray-600', 'text-primary', 'shadow');
                    tabLogin.classList.remove('text-gray-600', 'dark:text-gray-300');
                    tabRegister.classList.remove('bg-white', 'dark:bg-gray-600', 'text-primary', 'shadow');
                    tabRegister.classList.add('text-gray-600', 'dark:text-gray-300');
                    loginForm.classList.remove('hidden');
                    registerForm.classList.add('hidden');
                });

                tabRegister.addEventListener('click', () => {
                    tabRegister.classList.add('bg-white', 'dark:bg-gray-600', 'text-primary', 'shadow');
                    tabRegister.classList.remove('text-gray-600', 'dark:text-gray-300');
                    tabLogin.classList.remove('bg-white', 'dark:bg-gray-600', 'text-primary', 'shadow');
                    tabLogin.classList.add('text-gray-600', 'dark:text-gray-300');
                    registerForm.classList.remove('hidden');
                    loginForm.classList.add('hidden');
                });

                document.getElementById('btn-login').addEventListener('click', () => {
                    const email = document.getElementById('login-email').value;
                    const password = document.getElementById('login-password').value;
                    const errorDiv = document.getElementById('login-error');

                    if (DataManager.login(email, password)) {
                        this.render();
                    } else {
                        errorDiv.textContent = 'Email o contrase√±a incorrectos';
                        errorDiv.classList.remove('hidden');
                    }
                });

                document.getElementById('btn-register').addEventListener('click', () => {
                    const nombre = document.getElementById('register-nombre').value;
                    const email = document.getElementById('register-email').value;
                    const password = document.getElementById('register-password').value;
                    const errorDiv = document.getElementById('register-error');
                    const successDiv = document.getElementById('register-success');

                    errorDiv.classList.add('hidden');
                    successDiv.classList.add('hidden');

                    if (!nombre || !email || !password) {
                        errorDiv.textContent = 'Por favor complete todos los campos';
                        errorDiv.classList.remove('hidden');
                        return;
                    }

                    const result = DataManager.register(email, password, nombre);
                    if (result.success) {
                        successDiv.textContent = result.message + ' - Ahora puedes iniciar sesi√≥n';
                        successDiv.classList.remove('hidden');
                        document.getElementById('register-nombre').value = '';
                        document.getElementById('register-email').value = '';
                        document.getElementById('register-password').value = '';
                    } else {
                        errorDiv.textContent = result.message;
                        errorDiv.classList.remove('hidden');
                    }
                });
            }

            attachDashboardEvents(user) {
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        this.currentView = e.currentTarget.dataset.view;
                        this.render();
                    });
                });

                document.getElementById('btn-logout').addEventListener('click', () => {
                    DataManager.logout();
                    this.currentView = 'login';
                    this.render();
                });

                // Eventos espec√≠ficos por vista
                if (this.currentView === 'servicios') {
                    this.attachServiciosEvents();
                } else if (this.currentView === 'barberos') {
                    this.attachBarberosEvents();
                } else if (this.currentView === 'reservar') {
                    this.attachReservarEvents();
                } else if (this.currentView === 'mis-citas') {
                    this.attachMisCitasEvents();
                } else if (this.currentView === 'asignar-citas') {
                    this.attachAsignarCitasEvents();
                }
            }

            attachServiciosEvents() {
                document.getElementById('btn-add-servicio').addEventListener('click', () => {
                    this.showServicioModal();
                });

                document.querySelectorAll('.btn-edit-servicio').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.dataset.id;
                        const servicio = DataManager.getServicios().find(s => s.id === id);
                        this.showServicioModal(servicio);
                    });
                });

                document.querySelectorAll('.btn-delete-servicio').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.dataset.id;
                        this.showConfirmModal('¬øEst√° seguro de eliminar este servicio?', () => {
                            let servicios = DataManager.getServicios();
                            servicios = servicios.filter(s => s.id !== id);
                            DataManager.setServicios(servicios);
                            this.render();
                        });
                    });
                });
            }

            attachBarberosEvents() {
                document.getElementById('btn-add-barbero').addEventListener('click', () => {
                    this.showBarberoModal();
                });

                document.querySelectorAll('.btn-edit-barbero').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.dataset.id;
                        const barbero = DataManager.getBarberos().find(b => b.id === id);
                        this.showBarberoModal(barbero);
                    });
                });

                document.querySelectorAll('.btn-delete-barbero').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.dataset.id;
                        this.showConfirmModal('¬øEst√° seguro de eliminar este barbero?', () => {
                            let barberos = DataManager.getBarberos();
                            barberos = barberos.filter(b => b.id !== id);
                            DataManager.setBarberos(barberos);
                            this.render();
                        });
                    });
                });
            }

            attachReservarEvents() {
                const selectServicio = document.getElementById('select-servicio');
                const inputFecha = document.getElementById('input-fecha');
                const horariosDiv = document.getElementById('horarios-disponibles');
                const btnConfirmar = document.getElementById('btn-confirmar-reserva');

                let selectedSlot = null;

                // Establecer fecha m√≠nima (hoy)
                const today = new Date().toISOString().split('T')[0];
                inputFecha.min = today;

                const updateSlots = () => {
                    const servicioId = selectServicio.value;
                    const fecha = inputFecha.value;

                    if (!servicioId || !fecha) {
                        horariosDiv.classList.add('hidden');
                        btnConfirmar.disabled = true;
                        return;
                    }

                    const servicio = DataManager.getServicios().find(s => s.id === servicioId);
                    if (!servicio) return;

                    const slots = this.calcularSlotsDisponibles(fecha, servicio.duracion);
                    const slotsContainer = document.getElementById('slots-container');
                    slotsContainer.innerHTML = '';

                    if (slots.length === 0) {
                        slotsContainer.innerHTML = '<p class="col-span-full text-center text-gray-500">No hay horarios disponibles para esta fecha</p>';
                        horariosDiv.classList.remove('hidden');
                        btnConfirmar.disabled = true;
                        return;
                    }

                    slots.forEach(slot => {
                        const btn = document.createElement('button');
                        btn.className = 'px-4 py-2 rounded-lg border-2 border-gray-300 dark:border-gray-600 hover:border-primary hover:bg-primary/10 transition-all text-base font-medium';
                        btn.textContent = slot;
                        btn.addEventListener('click', () => {
                            slotsContainer.querySelectorAll('button').forEach(b => {
                                b.className = 'px-4 py-2 rounded-lg border-2 border-gray-300 dark:border-gray-600 hover:border-primary hover:bg-primary/10 transition-all text-base font-medium';
                            });
                            btn.className = 'px-4 py-2 rounded-lg border-2 border-primary bg-primary text-white transition-all text-base font-medium';
                            selectedSlot = slot;
                            btnConfirmar.disabled = false;
                        });
                        slotsContainer.appendChild(btn);
                    });

                    horariosDiv.classList.remove('hidden');
                };

                selectServicio.addEventListener('change', updateSlots);
                inputFecha.addEventListener('change', updateSlots);

                btnConfirmar.addEventListener('click', () => {
                    const servicioId = selectServicio.value;
                    const fecha = inputFecha.value;
                    const user = DataManager.getCurrentUser();

                    if (!servicioId || !fecha || !selectedSlot) return;

                    const [hora, minuto] = selectedSlot.split(':');
                    const fechaHora = new Date(fecha);
                    fechaHora.setHours(parseInt(hora), parseInt(minuto), 0, 0);

                    const nuevaCita = {
                        id: Date.now().toString(),
                        cliente_id: user.id,
                        servicio_id: servicioId,
                        barbero_id: null,
                        fecha_hora: fechaHora.toISOString(),
                        estado_asignacion: 'PENDIENTE'
                    };

                    const citas = DataManager.getCitas();
                    citas.push(nuevaCita);
                    DataManager.setCitas(citas);

                    const successDiv = document.getElementById('reserva-success');
                    successDiv.textContent = '¬°Cita reservada exitosamente! El administrador asignar√° un barbero pronto.';
                    successDiv.classList.remove('hidden');

                    setTimeout(() => {
                        this.currentView = 'mis-citas';
                        this.render();
                    }, 2000);
                });
            }

            attachMisCitasEvents() {
                document.querySelectorAll('.btn-cancelar-cita').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.dataset.id;
                        this.showConfirmModal('¬øEst√° seguro de cancelar esta cita?', () => {
                            let citas = DataManager.getCitas();
                            citas = citas.filter(c => c.id !== id);
                            DataManager.setCitas(citas);
                            this.render();
                        });
                    });
                });
            }

            attachAsignarCitasEvents() {
                document.querySelectorAll('.select-barbero-asignar').forEach(select => {
                    select.addEventListener('change', (e) => {
                        const citaId = e.currentTarget.dataset.citaId;
                        const btn = document.querySelector(`.btn-asignar[data-cita-id="${citaId}"]`);
                        btn.disabled = !e.currentTarget.value;
                    });
                });

                document.querySelectorAll('.btn-asignar').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const citaId = e.currentTarget.dataset.citaId;
                        const select = document.querySelector(`.select-barbero-asignar[data-cita-id="${citaId}"]`);
                        const barberoId = select.value;

                        if (!barberoId) return;

                        const citas = DataManager.getCitas();
                        const cita = citas.find(c => c.id === citaId);
                        const barbero = DataManager.getBarberos().find(b => b.id === barberoId);

                        if (!cita || !barbero) return;

                        // Validar conflictos de horarios
                        const fechaCita = new Date(cita.fecha_hora);
                        const servicio = DataManager.getServicios().find(s => s.id === cita.servicio_id);
                        const duracionMinutos = servicio ? servicio.duracion : 30;
                        const finCita = new Date(fechaCita.getTime() + duracionMinutos * 60000);

                        const conflicto = citas.find(c =>
                            c.id !== citaId &&
                            c.barbero_id === barberoId &&
                            c.estado_asignacion === 'ASIGNADO' &&
                            this.hayConflictoHorario(new Date(c.fecha_hora), fechaCita, finCita, c.servicio_id)
                        );

                        const errorDiv = document.querySelector(`.asignar-error-${citaId}`);

                        if (conflicto) {
                            errorDiv.textContent = 'El barbero ya tiene una cita en este horario';
                            errorDiv.classList.remove('hidden');
                            return;
                        }

                        // Verificar horario de trabajo del barbero
                        const hora = fechaCita.getHours();
                        const minuto = fechaCita.getMinutes();
                        const horaActual = hora + minuto / 60;
                        const [horaIni, minIni] = barbero.horario_inicio.split(':');
                        const [horaFin, minFin] = barbero.horario_fin.split(':');
                        const horarioIni = parseInt(horaIni) + parseInt(minIni) / 60;
                        const horarioFin = parseInt(horaFin) + parseInt(minFin) / 60;

                        if (horaActual < horarioIni || horaActual >= horarioFin) {
                            errorDiv.textContent = 'La cita est√° fuera del horario de trabajo del barbero';
                            errorDiv.classList.remove('hidden');
                            return;
                        }

                        // Asignar barbero
                        cita.barbero_id = barberoId;
                        cita.estado_asignacion = 'ASIGNADO';
                        DataManager.setCitas(citas);

                        this.render();
                    });
                });
            }

            // ========================================
            // UTILIDADES
            // ========================================
            calcularSlotsDisponibles(fecha, duracion) {
                const slots = [];
                const horaInicio = 9; // 9 AM
                const horaFin = 19; // 7 PM
                const intervalo = 30; // minutos

                // Generar todos los slots posibles
                for (let hora = horaInicio; hora < horaFin; hora++) {
                    for (let minuto = 0; minuto < 60; minuto += intervalo) {
                        const horaStr = hora.toString().padStart(2, '0');
                        const minutoStr = minuto.toString().padStart(2, '0');

                        // Verificar si el slot + duraci√≥n del servicio cabe antes de horaFin
                        const finSlot = hora + (minuto + duracion) / 60;
                        if (finSlot <= horaFin) {
                            slots.push(`${horaStr}:${minutoStr}`);
                        }
                    }
                }

                // Filtrar slots que ya tienen citas asignadas
                const citas = DataManager.getCitas();
                const citasFecha = citas.filter(c => {
                    const fechaCita = new Date(c.fecha_hora);
                    const fechaSeleccionada = new Date(fecha);
                    return fechaCita.toDateString() === fechaSeleccionada.toDateString() &&
                           c.estado_asignacion === 'ASIGNADO';
                });

                return slots.filter(slot => {
                    const [hora, minuto] = slot.split(':');
                    const inicioSlot = new Date(fecha);
                    inicioSlot.setHours(parseInt(hora), parseInt(minuto), 0, 0);
                    const finSlot = new Date(inicioSlot.getTime() + duracion * 60000);

                    // Verificar si hay conflicto con alguna cita existente
                    return !citasFecha.some(c => {
                        const inicioCita = new Date(c.fecha_hora);
                        const servicioCita = DataManager.getServicios().find(s => s.id === c.servicio_id);
                        const duracionCita = servicioCita ? servicioCita.duracion : 30;
                        const finCita = new Date(inicioCita.getTime() + duracionCita * 60000);

                        // Hay conflicto si los horarios se superponen
                        return (inicioSlot < finCita && finSlot > inicioCita);
                    });
                });
            }

            hayConflictoHorario(fechaCitaExistente, inicioNueva, finNueva, servicioIdExistente) {
                const servicioExistente = DataManager.getServicios().find(s => s.id === servicioIdExistente);
                const duracionExistente = servicioExistente ? servicioExistente.duracion : 30;
                const finExistente = new Date(fechaCitaExistente.getTime() + duracionExistente * 60000);

                return (inicioNueva < finExistente && finNueva > fechaCitaExistente);
            }

            showServicioModal(servicio = null) {
                const isEdit = !!servicio;
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 modal-overlay flex items-center justify-center z-50 px-4';
                modal.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-8 w-full max-w-md fade-in">
                        <h3 class="text-2xl font-bold mb-6">${isEdit ? 'Editar' : 'Nuevo'} Servicio</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Nombre del Servicio</label>
                                <input type="text" id="modal-nombre" class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary" value="${servicio ? servicio.nombre : ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Duraci√≥n (minutos)</label>
                                <input type="number" id="modal-duracion" class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary" value="${servicio ? servicio.duracion : '30'}" min="15" step="15">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Precio ($)</label>
                                <input type="number" id="modal-precio" class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary" value="${servicio ? servicio.precio : '20'}" min="1">
                            </div>
                            <div id="modal-error" class="hidden text-red-500 text-sm"></div>
                            <div class="flex space-x-3 pt-4">
                                <button id="modal-cancel" class="flex-1 px-4 py-3 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-all text-base font-medium">
                                    Cancelar
                                </button>
                                <button id="modal-save" class="flex-1 px-4 py-3 bg-primary hover:bg-primary/90 text-white rounded-lg transition-all text-base font-medium">
                                    ${isEdit ? 'Guardar' : 'Crear'}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                modal.querySelector('#modal-cancel').addEventListener('click', () => modal.remove());
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.remove();
                });

                modal.querySelector('#modal-save').addEventListener('click', () => {
                    const nombre = modal.querySelector('#modal-nombre').value.trim();
                    const duracion = parseInt(modal.querySelector('#modal-duracion').value);
                    const precio = parseFloat(modal.querySelector('#modal-precio').value);
                    const errorDiv = modal.querySelector('#modal-error');

                    if (!nombre || !duracion || !precio) {
                        errorDiv.textContent = 'Por favor complete todos los campos';
                        errorDiv.classList.remove('hidden');
                        return;
                    }

                    let servicios = DataManager.getServicios();
                    if (isEdit) {
                        const index = servicios.findIndex(s => s.id === servicio.id);
                        servicios[index] = { ...servicio, nombre, duracion, precio };
                    } else {
                        servicios.push({
                            id: Date.now().toString(),
                            nombre,
                            duracion,
                            precio
                        });
                    }
                    DataManager.setServicios(servicios);
                    modal.remove();
                    this.render();
                });
            }

            showBarberoModal(barbero = null) {
                const isEdit = !!barbero;
                const users = DataManager.getUsers();
                const clientesDisponibles = users.filter(u => u.rol === 'CLIENTE' || u.rol === 'BARBERO');

                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 modal-overlay flex items-center justify-center z-50 px-4';
                modal.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-8 w-full max-w-md fade-in">
                        <h3 class="text-2xl font-bold mb-6">${isEdit ? 'Editar' : 'Nuevo'} Barbero</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Usuario (Email)</label>
                                <select id="modal-usuario" class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary" ${isEdit ? 'disabled' : ''}>
                                    <option value="">Seleccione un usuario</option>
                                    ${clientesDisponibles.map(u => `
                                        <option value="${u.id}" ${barbero && barbero.usuario_id === u.id ? 'selected' : ''}>${u.nombre} (${u.email})</option>
                                    `).join('')}
                                </select>
                                ${isEdit ? '<p class="text-xs text-gray-500 mt-1">No se puede cambiar el usuario de un barbero existente</p>' : ''}
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Horario Inicio</label>
                                <input type="time" id="modal-horario-inicio" class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary" value="${barbero ? barbero.horario_inicio : '09:00'}">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Horario Fin</label>
                                <input type="time" id="modal-horario-fin" class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-base focus:ring-2 focus:ring-primary" value="${barbero ? barbero.horario_fin : '18:00'}">
                            </div>
                            <div id="modal-error" class="hidden text-red-500 text-sm"></div>
                            <div class="flex space-x-3 pt-4">
                                <button id="modal-cancel" class="flex-1 px-4 py-3 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-all text-base font-medium">
                                    Cancelar
                                </button>
                                <button id="modal-save" class="flex-1 px-4 py-3 bg-primary hover:bg-primary/90 text-white rounded-lg transition-all text-base font-medium">
                                    ${isEdit ? 'Guardar' : 'Crear'}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                modal.querySelector('#modal-cancel').addEventListener('click', () => modal.remove());
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.remove();
                });

                modal.querySelector('#modal-save').addEventListener('click', () => {
                    const usuarioId = modal.querySelector('#modal-usuario').value;
                    const horarioInicio = modal.querySelector('#modal-horario-inicio').value;
                    const horarioFin = modal.querySelector('#modal-horario-fin').value;
                    const errorDiv = modal.querySelector('#modal-error');

                    if (!usuarioId || !horarioInicio || !horarioFin) {
                        errorDiv.textContent = 'Por favor complete todos los campos';
                        errorDiv.classList.remove('hidden');
                        return;
                    }

                    let barberos = DataManager.getBarberos();

                    // Verificar que el usuario no sea ya barbero (solo en creaci√≥n)
                    if (!isEdit && barberos.find(b => b.usuario_id === usuarioId)) {
                        errorDiv.textContent = 'Este usuario ya es barbero';
                        errorDiv.classList.remove('hidden');
                        return;
                    }

                    if (isEdit) {
                        const index = barberos.findIndex(b => b.id === barbero.id);
                        barberos[index] = { ...barbero, horario_inicio: horarioInicio, horario_fin: horarioFin };
                    } else {
                        barberos.push({
                            id: Date.now().toString(),
                            usuario_id: usuarioId,
                            horario_inicio: horarioInicio,
                            horario_fin: horarioFin
                        });

                        // Actualizar rol del usuario a BARBERO
                        const users = DataManager.getUsers();
                        const userIndex = users.findIndex(u => u.id === usuarioId);
                        if (userIndex !== -1) {
                            users[userIndex].rol = 'BARBERO';
                            DataManager.setUsers(users);
                        }
                    }

                    DataManager.setBarberos(barberos);
                    modal.remove();
                    this.render();
                });
            }

            showConfirmModal(message, onConfirm) {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 modal-overlay flex items-center justify-center z-50 px-4';
                modal.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-8 w-full max-w-md fade-in">
                        <h3 class="text-xl font-bold mb-4">Confirmar Acci√≥n</h3>
                        <p class="text-gray-700 dark:text-gray-300 mb-6">${message}</p>
                        <div class="flex space-x-3">
                            <button id="modal-cancel" class="flex-1 px-4 py-3 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-all text-base font-medium">
                                Cancelar
                            </button>
                            <button id="modal-confirm" class="flex-1 px-4 py-3 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-all text-base font-medium">
                                Confirmar
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                modal.querySelector('#modal-cancel').addEventListener('click', () => modal.remove());
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.remove();
                });

                modal.querySelector('#modal-confirm').addEventListener('click', () => {
                    onConfirm();
                    modal.remove();
                });
            }
        }

        // ========================================
        // 4. INICIALIZACI√ìN
        // ========================================
        document.addEventListener('DOMContentLoaded', () => {
            new App();
        });
    </script>
</body>
</html>
